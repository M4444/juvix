name: juvix-ci-build-pr
kind: pipeline
node:
  project: juvix
steps:
- name: check-scripts-integrity
  image: alpine/git:v2.30.1
  pull: never
- name: restore-cache
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/{{ checksum "stack.yaml" }}
    mount:
    - ./.stack-work
    - ./.stack
    region: eu-west-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  depends_on:
  - check-scripts-integrity
- name: test-suite
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/juvix:latest
  pull: never
  commands:
  - make stack-yaml
  - make update-local-stdlibs
  - make test
  depends_on:
  - restore-cache
- name: test-parser
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/juvix:latest
  pull: never
  commands:
  - make test-parser
  depends_on:
  - test-suite
- name: test-typecheck
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/juvix:latest
  pull: never
  commands:
  - make test-typecheck
  depends_on:
  - test-suite
- name: test-compile
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/juvix:latest
  pull: never
  commands:
  - make test-compile
  depends_on:
  - test-suite
- name: org-generation-and-code-formatting
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/juvix:latest
  pull: never
  commands:
  - sh ./scripts/format-and-org-gen.sh
  depends_on:
  - test-typecheck
  - test-compile
  - test-parser
- name: build-checksums
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
  pull: never
  commands:
  - python3 scripts/generate-checksums.py
  environment:
    GITHUB_TOKEN:
      from_secret: github_token
  depends_on:
  - test-typecheck
  - test-compile
  - test-parser
- name: push-changes
  image: openanalytics/alpine-git-lfs-client
  pull: never
  commands:
  - sh ./scripts/push-changes.sh
  environment:
    GITHUB_TOKEN:
      from_secret: github_token
  depends_on:
  - org-generation-and-code-formatting
  - build-checksums
- name: rebuild-cache
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/{{ checksum "stack.yaml" }}
    mount:
    - ./.stack-work
    - ./.stack
    override: false
    region: eu-west-1
    rebuild: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - push-changes
  when:
    status:
    - success
    - failure
trigger:
  event:
  - pull_request
type: docker
workspace:
  path: /drone/workspace
environment:
  GIT_LFS_SKIP_SMUDGE: '1'
  STACK_ROOT: /drone/workspace/.stack
---
name: juvix-ci-build-push-develop
kind: pipeline
node:
  project: juvix
steps:
- name: check-scripts-integrity
  image: alpine/git:v2.30.1
  pull: never
- name: restore-cache
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/{{ checksum "stack.yaml" }}
    mount:
    - ./.stack-work
    - ./.stack
    region: eu-west-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  depends_on:
  - check-scripts-integrity
- name: test-suite
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/juvix:latest
  pull: never
  commands:
  - make stack-yaml
  - make update-local-stdlibs
  - make test
  depends_on:
  - restore-cache
- name: test-parser
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/juvix:latest
  pull: never
  commands:
  - make test-parser
  depends_on:
  - test-suite
- name: test-typecheck
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/juvix:latest
  pull: never
  commands:
  - make test-typecheck
  depends_on:
  - test-suite
- name: test-compile
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/juvix:latest
  pull: never
  commands:
  - make test-compile
  depends_on:
  - test-suite
- name: rebuild-cache
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/{{ checksum "stack.yaml" }}
    mount:
    - ./.stack-work
    - ./.stack
    override: false
    region: eu-west-1
    rebuild: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - test-compile
  - test-typecheck
  - test-parser
  when:
    status:
    - success
    - failure
trigger:
  event:
  - push
  branch:
  - develop
type: docker
workspace:
  path: /drone/workspace
environment:
  GIT_LFS_SKIP_SMUDGE: '1'
  STACK_ROOT: /drone/workspace/.stack
---
name: juvix-ci-docs-pr-push-develop
kind: pipeline
node:
  project: juvix
steps:
- name: check-scripts-integrity
  image: alpine/git:v2.30.1
  pull: never
- name: restore-cache-stack
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "stack.yaml" }}
    mount:
    - ./.stack
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-plonk
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Backends/Plonk/stack.yaml" }}
    mount:
    - library/Backends/Plonk/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-michelson
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Backends/Michelson/stack.yaml" }}
    mount:
    - library/Backends/Michelson/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-parsing
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Parsing/stack.yaml" }}
    mount:
    - library/Parsing/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-core
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Core/stack.yaml" }}
    mount:
    - library/Core/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-standard-library
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/StandardLibrary/stack.yaml" }}
    mount:
    - library/StandardLibrary/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-witch
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Witch/stack.yaml" }}
    mount:
    - library/Witch/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-context
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Context/stack.yaml" }}
    mount:
    - library/Context/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-sexp
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Sexp/stack.yaml" }}
    mount:
    - library/Sexp/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-translate
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Translate/stack.yaml" }}
    mount:
    - library/Translate/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-http
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Playground/HTTP/stack.yaml" }}
    mount:
    - library/Playground/HTTP/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-easy
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Playground/Easy/stack.yaml" }}
    mount:
    - library/Playground/Easy/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-data-structure
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Test/DataStructures/stack.yaml" }}
    mount:
    - library/Test/DataStructures/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: restore-cache-llvm
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Backends/llvm/stack.yaml" }}
    mount:
    - library/Backends/llvm/.stack-work
    override: false
    region: eu-west-1
    rebuild: false
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 16m
  depends_on:
  - check-scripts-integrity
  when:
    status:
    - success
    - failure
- name: build-docs
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/juvix:latest
  pull: never
  commands:
  - ./scripts/build-and-publish-docs.sh
  environment:
    GITHUB_TOKEN:
      from_secret: github_token
  depends_on:
  - restore-cache-stack
  - restore-cache-context
  - restore-cache-core
  - restore-cache-data-structure
  - restore-cache-easy
  - restore-cache-parsing
  - restore-cache-http
  - restore-cache-llvm
  - restore-cache-michelson
  - restore-cache-plonk
  - restore-cache-sexp
  - restore-cache-standard-library
  - restore-cache-translate
  - restore-cache-witch
- name: rebuild-cache-stack
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "stack.yaml" }}
    mount:
    - ./.stack
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-plonk
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Backends/Plonk/stack.yaml" }}
    mount:
    - library/Backends/Plonk/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
    - failure
- name: rebuild-cache-michelson
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Backends/Michelson/stack.yaml" }}
    mount:
    - library/Backends/Michelson/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-parsing
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Parsing/stack.yaml" }}
    mount:
    - library/Parsing/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-core
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Core/stack.yaml" }}
    mount:
    - library/Core/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-standard-library
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/StandardLibrary/stack.yaml" }}
    mount:
    - library/StandardLibrary/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-witch
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Witch/stack.yaml" }}
    mount:
    - library/Witch/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-context
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Context/stack.yaml" }}
    mount:
    - library/Context/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-sexp
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Sexp/stack.yaml" }}
    mount:
    - library/Sexp/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-translate
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Translate/stack.yaml" }}
    mount:
    - library/Translate/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-http
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Playground/HTTP/stack.yaml" }}
    mount:
    - library/Playground/HTTP/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-easy
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Playground/Easy/stack.yaml" }}
    mount:
    - library/Playground/Easy/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-data-structure
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Test/DataStructures/stack.yaml" }}
    mount:
    - library/Test/DataStructures/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 8m
  depends_on:
  - build-docs
  when:
    status:
    - success
- name: rebuild-cache-llvm
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/docs/{{ checksum "library/Backends/llvm/stack.yaml" }}
    mount:
    - library/Backends/llvm/.stack-work
    override: false
    region: eu-west-1
    rebuild: true
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BACKEND_OPERATION_TIMEOUT: 16m
  depends_on:
  - build-docs
  when:
    status:
    - success
trigger:
  event:
  - push
  - pull_request
  branch:
  - develop
type: docker
workspace:
  path: /drone/workspace
environment:
  GIT_LFS_SKIP_SMUDGE: '1'
  STACK_ROOT: /drone/workspace/.stack
---
name: juvix-ci-update-artifacts-push-develop
kind: pipeline
node:
  project: juvix
steps:
- name: check-scripts-integrity
  image: alpine/git:v2.30.1
  pull: never
- name: upload-artifacts
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
  pull: never
  commands:
  - aws s3 sync stdlib s3://heliax-juvix-artifacts-v1 --acl public-read --exclude
    "*" --include "*.json" --include "*/*.ju" --include "*.ju"
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  depends_on:
  - check-scripts-integrity
trigger:
  event:
  - push
  branch:
  - develop
type: docker
workspace:
  path: /drone/workspace
environment:
  GIT_LFS_SKIP_SMUDGE: '1'
  STACK_ROOT: /drone/workspace/.stack
---
name: juvix-ci-deploy-website
kind: pipeline
node:
  project: juvix
steps:
- name: check-scripts-integrity
  image: alpine/git:v2.30.1
  pull: never
- name: restore-cache-frontend
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/backend/{{ checksum "library/Playground/HTTP/compiler-debugger/package-lock.json"
      }}
    mount:
    - ./library/Playground/compiler-debugger/node_modules
    region: eu-west-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  depends_on:
  - check-scripts-integrity
- name: restore-cache-backend
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/backend/{{ checksum "library/Playground/HTTP/stack.yaml" }}
    mount:
    - ./library/Playground/HTTP/.stack-work
    - ./.stack
    region: eu-west-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  depends_on:
  - check-scripts-integrity
- name: build-frontend
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/node:14.18.2-stretch
  pull: never
  commands:
  - cd library/Playground/HTTP/compiler-debugger && npm install && npm run build
  environment:
    API_URL: https://juvix-api.heliax.dev
  depends_on:
  - restore-cache-frontend
- name: build-backend
  image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/juvix:latest
  pull: never
  commands:
  - cd library/Playground/HTTP && stack build
  depends_on:
  - restore-cache-backend
- name: deploy-backend
  image: appleboy/drone-scp
  pull: never
  settings:
    host: juvix-api.heliax.dev
    username: ubuntu
    key:
      from_secret: ssh_key
    target: ~/
    source: ./library/Playground/HTTP/.stack-work/dist/x86_64-linux/Cabal-3.2.1.0/build/juvix-server
  depends_on:
  - build-backend
- name: deploy-frontend
  image: plugins/s3-sync:1
  pull: never
  settings:
    bucket: juvix.heliax.dev
    access_key:
      from_secret: aws_access_key_id
    secret_key:
      from_secret: aws_secret_access_key
    region: eu-west-1
    source: library/Playground/HTTP/compiler-debugger/build
    cloudfront_distribution: E2JJLE9WAN786S
  depends_on:
  - build-frontend
- name: reload-backend
  image: appleboy/drone-ssh
  pull: never
  settings:
    host: 54.155.84.137
    username: ubuntu
    key:
      from_secret: ssh_key
    script:
    - ./start.sh
  environment:
    SSH_KEY:
      from_secret: ssh_key
  depends_on:
  - deploy-backend
- name: rebuild-cache-backend
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/backend/{{ checksum "library/Playground/HTTP/stack.yaml" }}
    mount:
    - ./library/Playground/HTTP/.stack-work
    - ./.stack
    region: eu-west-1
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  depends_on:
  - reload-backend
- name: rebuild-cache-frontend
  image: meltwater/drone-cache:latest
  pull: never
  settings:
    archive_format: gzip
    backend: s3
    bucket: heliax-drone-cache-v2
    cache_key: juvix/backend/{{ checksum "library/Playground/HTTP/compiler-debugger/package-lock.json"
      }}
    mount:
    - ./library/Playground/compiler-debugger/node_modules
    region: eu-west-1
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  depends_on:
  - deploy-frontend
trigger:
  event:
  - push
  - pull_request
  branch:
  - develop
type: docker
workspace:
  path: /drone/workspace/web
environment:
  GIT_LFS_SKIP_SMUDGE: '1'
  STACK_ROOT: /drone/workspace/web/.stack
